# 使用注解进行SQL映射

在上一篇文章中,我们知道了如果在XML文件中配置映射语句.

下面我们来看看如果使用注解进行SQL映射.

## 语句映射

### @Insert

```java
public interface StudentMapper
{
    @Insert("INSERT INTO STUDENTS(STUD_ID,NAME,EMAIL,ADDR_ID, PHONE)
    VALUES(#{studId},#{name},#{email},#{address.addrId},#{phone})")
    // 获取生成的键
    // @Options(useGeneratedKeys=true, keyProperty="studId")
    // 不是所有的数据库都支持auto_increment 例如Oracle 这时候我们要
   	/* @SelectKey(statement="SELECT STUD_ID_SEQ.NEXTVAL FROM DUAL",
                  keyProperty="studId", resultType=int.class, before=true)
    */
    int insertStudent(Student student);
}
```

### @Update

```java
@Update("UPDATE STUDENTS SET NAME=#{name}, EMAIL=#{email},PHONE=#{phone}    WHERE STUD_ID=#{studId}")
int updateStudent(Student student);
// 该方法会返回Update操作修改了多少行数据
```

### @Delete

```java
@Delete("DELETE FROM STUDENTS WHERE STUD_ID=#{studId}")
int deleteStudent(int studId);
// 返回删除了多少行
```

### @Select

```java
package com.mybatis3.mappers;
public interface StudentMapper
{
    @Select("SELECT STUD_ID AS STUDID, NAME, EMAIL, PHONE FROM"+
    "STUDENTS WHERE STUD_ID=#{studId}")
    Student findStudentById(Integer studId);
}
```

## Result maps

```java
public interface StudentMapper
{
    @Select("SELECT * FROM STUDENTS")
    @Results({
        @Result(id=true, column="stud_id", property="studId"),
        @Result(column="name", property="name"),
        @Result(column="email", property="email"),
        @Result(column="addr_id", property="address.addrId")
    })
    List<Student> findAllStudents();
}
```

老司机可能马上就会发现,这样写不就意味着,需要不断的重复这段代码? 

是的,但是MyBatis有个补救方法,我们可以使用定义在映射文件中编写的resultMap

```xml
<mapper namespace="com.mybatis3.mappers.StudentMapper">
    <resultMap type="Student" id="StudentResult">
        <id property="studId" column="stud_id"/>
        <result property="name" column="name"/>
        <result property="email" column="email"/>
        <result property="phone" column="phone"/>
    </resultMap>
    <!--..............-->
</mapper>
```

```java
public interface StudentMapper
{
    @Select("SELECT * FROM STUDENTS WHERE STUD_ID=#{studId}")
    @ResultMap("com.mybatis3.mappers.StudentMapper.StudentResult")
    Student findStudentById(int studId);
    
    @Select("SELECT * FROM STUDENTS")
    @ResultMap("com.mybatis3.mappers.StudentMapper.StudentResult")
    List<Student> findAllStudents();
}
```

## 一对一映射

MyBatis提供@One注解使用嵌套Select语句从而读取一对一关联.

```java
public interface StudentMapper
{
    @Select("SELECT ADDR_ID AS ADDRID, STREET, CITY, STATE, ZIP, COUNTRY"+
    "FROM ADDRESSES WHERE ADDR_ID=#{id}")
    Address findAddressById(int id);
    
    @Select("SELECT * FROM STUDENTS WHERE STUD_ID=#{studId} ")
    @Results({
        @Result(id=true, column="stud_id", property="studId"),
        @Result(column="name", property="name"),
        @Result(column="email", property="email"),
        @Result(property="address", column="addr_id",
        one=@One(select="com.mybatis3.mappers.StudentMapper.findAddressById"))
    })
    Student selectStudentWithAddress(int studId);
}
```

## 一对多映射

MyBatis提供@Many注解使用嵌套Select语句从而读取一对多关联.

```java
public interface TutorMapper
{
    @Select("select addr_id as addrId, street, city, state, zip,"+
    "country from addresses where addr_id=#{id}")
    Address findAddressById(int id);
    
    @Select("select * from courses where tutor_id=#{tutorId}")
    @Results({
        @Result(id=true, column="course_id", property="courseId"),
        @Result(column="name", property="name"),
        @Result(column="description", property="description"),
        @Result(column="start_date" property="startDate"),
        @Result(column="end_date" property="endDate")
    })
    List<Course> findCoursesByTutorId(int tutorId);
    
    @Select("SELECT tutor_id, name as tutor_name, email, addr_id"+
    "FROM tutors where tutor_id=#{tutorId}")
    @Results({
        @Result(id=true, column="tutor_id", property="tutorId"),
        @Result(column="tutor_name", property="name"),
        @Result(column="email", property="email"),
        @Result(property="address", column="addr_id",
        one=@One(select=" com.mybatis3.mappers.TutorMapper.findAddressById")),
        @Result(property="courses", column="tutor_id",
        many=@Many(select="com.mybatis3.mappers.TutorMapper.findCoursesByTutorId"))
    })
    Tutor findTutorById(int tutorId);
}
```

## 动态SQL

### @SelectProvider

```java
public class TutorDynaSqlProvider{
    public String findTutorByIdSql(final int tutorId){
        return new SQL() {{
        SELECT("tutor_id as tutorId, name, email");
        FROM("tutors");
        WHERE("tutor_id="+tutorId);
        }}.toString();
    }
}
```

```java
@SelectProvider(type=TutorDynaSqlProvider.class,method="findTutorByIdSql")
Tutor findTutorById(int tutorId);
```

如果不需要传递参数

```java
public String findTutorByIdSql()
{
    return new SQL() {{
    SELECT("tutor_id as tutorId, name, email");
    FROM("tutors");
    WHERE("tutor_id = #{tutorId}");
    }}.toString();
}
```

注意:SqlProvider方法的参数有以下三种选项

- 没参数
- 只有一个与Mapper接口方法具有相同类型的参数
- java.util.Map

```java
@SelectProvider(type=TutorDynaSqlProvider.class,method="findTutorByNameAndEmailSql")
Tutor findTutorByNameAndEmail(String name, String email);
```

```java
public String findTutorByNameAndEmailSql(Map<String, Object> map)
{
    String name = (String) map.get("param1");
    String email = (String) map.get("param2");
    //you can also get those values using 0,1 keys
    //String name = (String) map.get("0");
    //String email = (String) map.get("1");
    return new SQL() {{
    SELECT("tutor_id as tutorId, name, email");
    FROM("tutors");
    WHERE("name=#{name} AND email=#{email}");
    }}.toString();
}
```

### @InsertProvider

```java
public class TutorDynaSqlProvider
{
    public String insertTutor(final Tutor tutor)
    {
        return new SQL() {{
            INSERT_INTO("TUTORS");
            if (tutor.getName() != null) {
                VALUES("NAME", "#{name}");
            }
            if (tutor.getEmail() != null) {
                VALUES("EMAIL", "#{email}");
            }
        }}.toString();
    }
}
```

```java
public interface TutorMapper
{
    @InsertProvider(type=TutorDynaSqlProvider.class,method="insertTutor")
    @Options(useGeneratedKeys=true, keyProperty="tutorId")
    int insertTutor(Tutor tutor);
}
```

### @UpdateProvider

```java
public class TutorDynaSqlProvider
{
    public String updateTutor(final Tutor tutor)
    {
        return new SQL() {{
            UPDATE("TUTORS");
            if (tutor.getName() != null) {
                SET("NAME = #{name}");
            }
            if (tutor.getEmail() != null) {
                SET("EMAIL = #{email}");
            }
            WHERE("TUTOR_ID = #{tutorId}");
        }}.toString();
    }
}
```

```java
public interface TutorMapper
{
    @UpdateProvider(type=TutorDynaSqlProvider.class,method="updateTutor")
    int updateTutor(Tutor tutor);
}
```

### @DeleteProvider

```java
public class TutorDynaSqlProvider
{
    public String deleteTutor(int tutorId)
    {
        return new SQL() {{
            DELETE_FROM("TUTORS");
            WHERE("TUTOR_ID = #{tutorId}");
        }}.toString();
    }
}
```

```java
public interface TutorMapper
{
    @DeleteProvider(type=TutorDynaSqlProvider.class,method="deleteTutor")
    int deleteTutor(int tutorId);
}
```

