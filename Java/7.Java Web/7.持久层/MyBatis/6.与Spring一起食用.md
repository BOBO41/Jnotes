# Spring整合MyBatis





## mybatis-spring模块

## 在Spring应用中配置MyBatis

在这里我们会讲述,如何在基于Spring框架的应用中安装和配置MyBatis.

```xml
<dependency>
    <groupId>org.mybatis</groupId>
    <artifactId>mybatis-spring</artifactId>
    <version>1.2.0</version>
</dependency>

<dependency>
<groupId>org.springframework</groupId>
<artifactId>spring-context-support</artifactId>
<version>3.1.3.RELEASE</version>
<exclusions>
    <exclusion>
        <groupId>commons-logging</groupId>
        <artifactId>commons-logging</artifactId>
    </exclusion>
</exclusions>
</dependency>

<dependency>
    <groupId>org.springframework</groupId>
    <artifactId>spring-jdbc</artifactId>
    <version>3.1.3.RELEASE</version>
</dependency>

<dependency>
    <groupId>org.springframework</groupId>
    <artifactId>spring-test</artifactId>
    <version>3.1.3.RELEASE</version>
    <scope>test</scope>
</dependency>

<dependency>
    <groupId>org.aspectj</groupId>
    <artifactId>aspectjrt</artifactId>
    <version>1.6.8</version>
</dependency>

<dependency>
    <groupId>org.aspectj</groupId>
    <artifactId>aspectjweaver</artifactId>
    <version>1.6.8</version>
</dependency>

<dependency>
    <groupId>cglib</groupId>
    <artifactId>cglib-nodep</artifactId>
    <version>2.2</version>
</dependency>

<dependency>
    <groupId>commons-dbcp</groupId>
    <artifactId>commons-dbcp</artifactId>
    <version>1.4</version>
</dependency>
```

使用MyBatis-Spring模块,我们只需要在SpringApplicationContext中配置MyBatis Bean即可,然后Spring会实例化SqlSessionFactory,创建SqlSession对象,并注入到DAO或者Service类.



## 配置MyBatis Beans

为了让Spring实例化MyBatis组件,例如SqlSessionFactory,SqlSession,以及Mapper对象,我们需要在Spring的bean定义文件applicationContext.xml中配置它们.

```xml
<beans>
    
    <bean id="dataSource"
          class="org.springframework.jdbc.datasource.DriverManagerDataSource">
        <property name="driverClassName" value="com.mysql.jdbc.Driver"/>
        <property name="url"value="jdbc:mysql://localhost:3306/elearning"/>
        <property name="username" value="root"/>
        <property name="password" value="admin"/>
    </bean>
    
    <bean id="sqlSessionFactory"
    class="org.mybatis.spring.SqlSessionFactoryBean">
        <property name="dataSource" ref="dataSource" />

        <property name="typeAliases" value="com.mybatis3.domain.Student,
        com.mybatis3.domain.Tutor"/>
        <property name="typeAliasesPackage" value="com.mybatis3.domain"/>

        <property name="typeHandlers"
        value="com.mybatis3.typehandlers.PhoneTypeHandler"/>
        <property name="typeHandlersPackage" value="com.mybatis3.typehandlers"/>
        
        <property name="mapperLocations" value="classpath*:com/mybatis3/**/*.xml" />
        <property name="configLocation" value="WEB-INF/mybatisconfig.xml"/>
    </bean>
    
</beans>
              
```

## 使用SqlSession

一旦我们配置了SqlSessionFactory Bean,我们就需要配置SqlSessionTemplate Bean.

SqlSessionTemplate Bean是一个线程安全的Spring bean, 通过它我们可以获取线程安全的SqlSession对象.

理论上来讲,SqlSessionTemplate 与Spirng DAO模式相似.

```xml
<bean id="sqlSession" class="org.mybatis.spring.SqlSessionTemplate">
    <constructor-arg index="0" ref="sqlSessionFactory" />
</bean>
```

现在,我们可以把SqlSession bean 注入到Spring bean,以及使用SqlSession对象调用被映射的SQL语句.

```java
public class StudentDaoImpl implements StudentDao{
	private SqlSession sqlSession;
    
	public void setSqlSession(SqlSession session){
    	this.sqlSession = session;
	}	

	public void createStudent(Student student){
    	StudentMapper mapper =this.sqlSession.getMapper(StudentMapper.class);
    	mapper.insertStudent(student);
	}

}
```

如果你使用基于XML的配置方法来配置Spring beans,你可以使用下面的方法把SqlSession Bean 注入到 DaoImpl bean中.

```xml
<bean id="studentDao" class="com.mybatis3.dao.StudentDaoImpl">
	<property name="sqlSession" ref="sqlSession" />
</bean>
```

如果你使用基于注解的配置方法来配置Spring beans,你可以使用下面的方法把SqlSession Bean 注入到 DaoImpl bean中.

```java
@Repository
public class StudentDaoImpl implements StudentDao{
    
    private SqlSession sqlSession;
    
    @Autowired
    public void setSqlSession(SqlSession session){
    	this.sqlSession = session;
    }
    
    public void createStudent(Student student){
        StudentMapper mapper =this.sqlSession.getMapper(StudentMapper.class);
        mapper.insertStudent(student);
    }
}
```

这里还有一种注入SqlSession对象的方法,那就是继承SqlSessionDaoSupport.通过这种方式我们除了可以映射语句,还能执行所有自定义的逻辑操作.

```java
public class StudentMapperImpl extends SqlSessionDaoSupport implements
StudentMapper{
    public void createStudent(Student student)
    {
        StudentMapper mapper =
        getSqlSession().getMapper(StudentMapper.class);
        mapper.insertAddress(student.getAddress());
        //Custom logic
        mapper.insertStudent(student);
    }
}
```

```xml
<bean id="studentMapper" class="com.mybatis3.dao.StudentMapperImpl">
    <property name="sqlSessionFactory" ref="sqlSessionFactory" />
</bean>
```

通过这种方式,我们注入SqlSession对象,获取Mapper实例,然后执行映射语句.Spring会提供线程安全SqlSession对象,以及在方法执行完毕后关闭SqlSession.

MyBatis-Spring模块为我们提供了更好的方式,我们可以直接注入Sql Mapper bean.

## 使用mappers

通过使用MapperFactoryBean我们做可以把mapper接口作为Spring bean来进行配置.

```java
public interface StudentMapper
{
    @Select("select stud_id as studId, name, email, phone from
    students where stud_id=#{id}")
    Student findStudentById(Integer id);
}
```

```xml
<bean id="studentMapper" class="org.mybatis.spring.mapper.MapperFactoryBean">
    <property name="mapperInterface" value="com.mybatis3.mappers.StudentMapper" />
    <property name="sqlSessionFactory" ref="sqlSessionFactory" />
</bean>
```

现在sutdentMapper可以被注入到任何Spring bean 然后调用映射语句.

```java
public class StudentService{
    private StudentMapper studentMapper;
    public void setStudentMapper (StudentMapperstudentMapper){
        this. studentMapper = studentMapper;
    }
    public void createStudent(Student student){
    	this.studentMapper.insertStudent(student);
    }
}
```

```java
<bean id="studentService" class="com.mybatis3.services.StudentService">
	<property name="studentMapper" ref="studentMapper" />
</bean>
```

### MapperScannerConfigurer

MapperScannerConfigurer会注册指定包中的所有Mapper

```java
<bean class="org.mybatis.spring.mapper.MapperScannerConfigurer">
    <property name="basePackage" value="com.mybatis3.mappers" />
</bean>
```

MyBatis-Spring-1.2.0 新增了两种扫描Mapper 接口的方法

• 使用 <mybatis:scan/> 元素
• 使用 @MapperScan 注解(requires Spring 3.1+)

### <mybatis:scan/>

<mybatis:scan>元素会搜索指定包中的Mapper接口.

```xml
<beans xmlns="http://www.springframework.org/schema/beans"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xmlns:mybatis="http://mybatis.org/schema/mybatis-spring"
xsi:schemaLocation="http://www.springframework.org/schema/beans
http://www.springframework.org/schema/beans/spring-beans.xsd
http://mybatis.org/schema/mybatis-spring
http://mybatis.org/schema/mybatis-spring.xsd">
    <mybatis:scan base-package="com.mybatis3.mappers" />
</beans>
```

mybatis:scan元素提供了以下属性,我们可以自定义扫描过程.

• annotation: 扫描器会注册指定包中所有的接口,并把指定接口作为父类.

• factory-ref: 指定使用哪一个SqlSessionFactory.通常在你需要用到多个datasource时才用到.

• marker-interface: 扫描器会注册指定包中所有具有特定注解的接口

• template-ref: 指定使用哪一个SqlSessionTemplate.通常在你需要用到多个datasource时才用到.

• name-generator: 用于命名与检测组件.

### @MapperScan

你可以使用@MapperScan注解来扫描Mapper接口,@MapperScan的工作方式与<mybatis:scan/>相类似.

```java
@Configuration
@MapperScan("com.mybatis3.mappers")
public class AppConfig{
    @Bean
    public DataSource dataSource() {
        return new PooledDataSource("com.mysql.jdbc.Driver",
        "jdbc:mysql://localhost:3306/elearning", "root", "admin");
    }
    @Bean
    public SqlSessionFactory sqlSessionFactory() throws Exception {
        SqlSessionFactoryBeansessionFactory = new SqlSessionFactoryBean();
        sessionFactory.setDataSource(dataSource());
        return sessionFactory.getObject();
    }
}
```

@MapperScan注解提供了以下属性,我们可以自定义扫描过程.

• annotationClass: 扫描器会注册指定包中所有具有指定注解的接口,.

• markerInterface: 扫描器会注册指定包中所有含有指定接口作为父类的接口.

• sqlSessionFactoryRef: 指定使用哪一个SqlSessionFactory.

• sqlSessionTemplateRef: 指定使用哪一个SqlSessionTemplate.

• nameGenerator: 用于命名和检测位于Spring容器中的组件.

• basePackageClasses: A type-safe alternative to basePackages() for
specifying the packages to scan for annotated components. The package
of each class specified will be scanned.

• basePackages: Base packages to scan for MyBatis interfaces. Note that only interfaces with at least one method will be registered; concrete classes will be ignored.

## 使用Spring进行事务管理

为了使用Spring的事务管理,我们需要在Spring application context配置TransactionManger Bean.

```xml
<bean id="transactionManager" class="org.springframework.jdbc.
datasource.DataSourceTransactionManager">
    <property name="dataSource" ref="dataSource" />
    <!--dataSource必须与SqlSessionFactory bean的相同.-->
</bean>
```

开启Spring基于注解的事务管理功能

```xml
<tx:annotation-driven transaction-manager="transactionManager"/>
```

现在你可以在Spring service beans中使用@Transactional注解,该注解说明service中每个方法都在事务中运行.

方法执行完毕则会提交事务,如果出现任何运行时异常则会业务回滚.另外Spring会把MyBatis Exception转化成DataAccessExceptions,从而额外为错误情况提供细节.

```java
@Service
@Transactional
public class StudentService{
    @Autowired
    private StudentMapper studentMapper;
    
    public Student createStudent(Student student){
        studentMapper.insertAddress(student.getAddress());
        if(student.getName().equalsIgnoreCase("")){
        	throw new RuntimeException("Student name should not beempty.");
        } 
        studentMapper.insertStudent(student);
        return student;
    }
}
```

下面是完整的Spring applicationContext.xml 文件

```xml
<beans>
    <context:annotation-config />
    <context:component-scan base-package="com.mybatis3" />
    <context:property-placeholder location="classpath:application.properties" />
    <tx:annotation-driven transaction-manager="transactionManager"/>
    
    <bean id="transactionManager"
    	class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
    	<property name="dataSource" ref="dataSource" />
    </bean>
    
    <bean class="org.mybatis.spring.mapper.MapperScannerConfigurer">
    	<property name="basePackage" value="com.mybatis3.mappers" />
    </bean>
    
    <bean id="sqlSession" class="org.mybatis.spring.SqlSessionTemplate">
    	<constructor-arg index="0" ref="sqlSessionFactory" />
    </bean>
    
    <bean id="sqlSessionFactory" class="org.mybatis.spring.SqlSessionFactoryBean">
    	<property name="dataSource" ref="dataSource" />
    	<property name="typeAliases"
  			value="com.mybatis3.domain.Student,com.mybatis3.domain.Tutor"/>
    	<property name="typeAliasesPackage" value="com.mybatis3.domain"/>
    	<property name="typeHandlers"
    		value="com.mybatis3.typehandlers.PhoneTypeHandler"/>
    	<property name="typeHandlersPackage" value="com.mybatis3.typehandlers"/>
    	<property name="mapperLocations" value="classpath*:com/mybatis3/**/*.xml" />
    </bean>
    
    <bean id="dataSource"
    	class="org.springframework.jdbc.datasource.DriverManagerDataSource">
        <property name="driverClassName" value="${jdbc.driverClassName}"/>
        <property name="url" value="${jdbc.url}"/>
        <property name="username" value="${jdbc.username}"/>
        <property name="password" value="${jdbc.password}"/>
    </bean>
    
</beans>
```

### 动手实践

```java
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations="classpath:applicationContext.xml")
public class StudentServiceTest{

    @Autowired
    private StudentService studentService;
    @Test
    public void testCreateStudent() {
        Address address = new Address(0,
        	"Quaker RidgeRd.","Bethel","Brooklyn","06801","USA");
        Student stud = new Student();
        long ts = System.currentTimeMillis();
        stud.setName("stud_"+ts);
        stud.setEmail("stud_"+ts+"@gmail.com");
        stud.setAddress(address);
        Student student = studentService.createStudent(stud);
        assertNotNull(student);
        assertEquals("stud_"+ts, student.getName());
        assertEquals("stud_"+ts+"@gmail.com", student.getEmail());
        System.err.println("CreatedStudent: "+student);
    }

    @Test(expected=DataAccessException.class)
    public void testCreateStudentForException() {
        Address address = new Address(0,
        	"Quaker RidgeRd.","Bethel","Brooklyn","06801","USA");
        Student stud = new Student();
        long ts = System.currentTimeMillis();
        stud.setName("Timothy");
        stud.setEmail("stud_"+ts+"@gmail.com");
        stud.setAddress(address);
        studentService.createStudent(stud);
        fail("You should not reach here");
    }
}
```

