## 1.连接到Redis

`org.springframework.data.redis.connection`包提供了

-   `RedisConnection`
-   `RedisConnectionFactory`

这两个接口用来从Redis中获取connection。

```java
@Configuration
@ComponentScan("com.hdr.hello.redis")
public class AppConfig {

   @Bean
   public LettuceConnectionFactory redisConnectionFactory() {
      RedisStandaloneConfiguration redisConf = new RedisStandaloneConfiguration();
      redisConf.setHostName("localhost");
      redisConf.setPort(6379);
      redisConf.setPassword("!@#$");
      return new LettuceConnectionFactory(redisConf);
   }
}
```

```java
@Autowired
private RedisConnectionFactory redisConnectionFactory;

@Test
public void main() {
   RedisConnection connection = redisConnectionFactory.getConnection();
   RedisStringCommands sc = connection.stringCommands();
   sc.set("name".getBytes(), "黄大仁".getBytes());
   connection.close();
}
```

## 2.RedisTemplate

`RedisConnection`提供的方法都是对二进制数据进行操作，所以我们一般使用`RedisTemplate`来对Redis进行操作。

`RedisTemplate`使用基于Java的序列化机制对对象或二进制数据进行序列化和反序列化。

`org.springframework.data.redis.serializer`提供了其他的序列化机制。

You can also set any of the serializers to null and use RedisTemplate with raw byte arrays by setting the `enableDefaultSerializer` property to `false`. Note that the template requires all keys to be non-null. However, values can be null as long as the underlying serializer accepts them. Read the Javadoc of each serializer for more information.

```java
@Bean
public RedisTemplate redisTemplate() {
   RedisTemplate redisTemplate = new RedisTemplate();
   redisTemplate.setConnectionFactory(redisConnectionFactory());
   return redisTemplate;
}
```

```java
@Resource(name = "redisTemplate")
private ListOperations<String, List<String>> listOpts;

@Test
public void rTemplate(){
   ArrayList<String> sList = new ArrayList<>();
   sList.add("hello");
   sList.add("world");
   listOpts.rightPush("text", sList);

   List<String> text = listOpts.leftPop("text");
   System.out.println(text);
}
```

### StringRedisTemplate

因为String用的多，所以特别提供了一个`StringRedisTemplate`。

```java
@Bean
public StringRedisTemplate stringRedisTemplate() {
   return new StringRedisTemplate(redisConnectionFactory());
}
```

```java
@Autowired
private StringRedisTemplate stringRedisTemplate;

@Test
public void sRT() {
   ListOperations<String, String> listOpts = stringRedisTemplate.opsForList();
   listOpts.rightPushAll("books","java 8 in action","redis in action","spring in action");
}
```

## 3.序列化器

`org.springframework.data.redis.serializer`提供了两种类型的序列化器：

-   Two-way serializers based on `RedisSerializer`.
-   Element readers and writers that use `RedisElementReader` and `RedisElementWriter`.

The main difference between these variants is that `RedisSerializer` primarily serializes to `byte[]` while readers and writers use `ByteBuffer`.

Multiple implementations are available (including two that have been already mentioned in this documentation):

-   `JdkSerializationRedisSerializer`, which is used by default for `RedisCache` and `RedisTemplate`.
-   the `StringRedisSerializer`.

However one can use `OxmSerializer` for Object/XML mapping through Spring [OXM](https://docs.spring.io/spring/docs/5.1.4.RELEASE/spring-framework-reference/data-access.html#oxm) support or `Jackson2JsonRedisSerializer` or `GenericJackson2JsonRedisSerializer` for storing data in [JSON](https://en.wikipedia.org/wiki/JSON) format.

Do note that the storage format is not limited only to values. It can be used for keys, values, or hashes without any restrictions.

## 4.Hash mapping

Spring Data Redis提供了各种将数据映射到哈希的策略。

-   Using `HashMapper` and `HashOperations`
-   Direct mapping, by using `HashOperations` and a [serializer](https://docs.spring.io/spring-data/data-redis/docs/2.1.4.RELEASE/reference/html/#redis:serializer)
-   Using [Redis Repositories](https://docs.spring.io/spring-data/data-redis/docs/2.1.4.RELEASE/reference/html/#redis.repositories)

### 4.1Hash Mappers

-   `BeanUtilsHashMapper` using Spring’s [BeanUtils](https://docs.spring.io/spring/docs/5.1.4.RELEASE/javadoc-api/org/springframework/beans/BeanUtils.html).
-   [`Jackson2HashMapper`](https://docs.spring.io/spring-data/data-redis/docs/2.1.4.RELEASE/reference/html/#redis.hashmappers.jackson2) using [FasterXML Jackson](https://github.com/FasterXML/jackson).
-   `ObjectHashMapper` using [Object-to-Hash Mapping](https://docs.spring.io/spring-data/data-redis/docs/2.1.4.RELEASE/reference/html/#redis.repositories.mapping).

#### ObjectHashMapper

```java
@Resource(name = "redisTemplate")
HashOperations<String, byte[], byte[]> hashOperations;
HashMapper<Object, byte[], byte[]> hashMapper = new ObjectHashMapper();

@Test
public void writeHash() {
   String key = "person";
   Person person = new Person("大仁", "黄");
   Map<byte[], byte[]> mappedHash = hashMapper.toHash(person);
   hashOperations.putAll(key, mappedHash);
}


@Test
public void loadHash() {
   String key = "person";
   Map<byte[], byte[]> loadedHash = hashOperations.entries(key);
   System.out.println(((Person) hashMapper.fromHash(loadedHash)));
}
```

#### Jackson2HashMapper

```java
@Bean
public RedisTemplate redisTemplate() {
   RedisTemplate redisTemplate = new RedisTemplate<>();
   redisTemplate.setConnectionFactory(redisConnectionFactory());
   return redisTemplate;
}

@Bean
public ObjectMapper objectMapper() {
   return new ObjectMapper();
}

@Bean
public Jackson2HashMapper jackson2HashMapper() {
   return new Jackson2HashMapper(objectMapper(), false);
}
```

```java
@Autowired
private Jackson2HashMapper jackson2HashMapper;
String key = "pig";

@Test
public void writeHash() {
   Person person = new Person("佩琪", "猪",new Address("GuangZhou", "China"));
   Map<String, Object> mappedHash = jackson2HashMapper.toHash(person);
   hashOperations.putAll(key, mappedHash);
}

@Test
public void loadHash() {
   Map<String, Object> entries = hashOperations.entries(key);
   Object map = jackson2HashMapper.fromHash(entries);
   Person person = new ObjectMapper().convertValue(map, Person.class);
   System.out.println(person);
}
```

这里没用到其他序列化器也，同样也能实现把Json转化，不太懂0.0

## 5.Redis Repositories

```java
@RedisHash("people")
public class Person {
  @Id String id;
  String firstname;
  String lastname;
  Address address;
}
```

```java
public interface PersonRepository extends CrudRepository<Person, String> {
	// 继承CrudRepository，获取基本的CRUD操作
}
```

```java
@Configuration
@EnableRedisRepositories
public class ApplicationConfig {

  @Bean
  public RedisConnectionFactory connectionFactory() {
    return new JedisConnectionFactory();
  }

  @Bean
  public RedisTemplate<?, ?> redisTemplate() {
		RedisTemplate<byte[], byte[]> redisTemplate = new RedisTemplate<>();
		redisTemplate.setConnectionFactory(redisConnectionFactory());
		return redisTemplate;
  }
}
```

```java
@Autowired 
PersonRepository repo;

public void basicCrudOperations() {
  Person rand = new Person("rand", "al'thor");
  rand.setAddress(new Address("emond's field", "andor"));
  repo.save(rand);                                         
  repo.findOne(rand.getId());                              
  repo.count();                                            
  repo.delete(rand);                                       
}
```

