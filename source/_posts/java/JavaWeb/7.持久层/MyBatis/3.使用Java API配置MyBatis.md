# 使用Java Api 配置MyBatis

## Environment

```java
Environment environment = new Environment("development",transactionFactory, dataSource);
```

### TransactionFactory

MyBatis提供以下两种TransactionFactory接口的实现类

• JdbcTransactionFactory
• ManagedTransactionFactory

如果应用程序在非管理环境下运行,你应该使用JdbcTransactionFactory.

```java
TransactionFactory transactionFactory = new JdbcTransactionFactory();
```

如果应用程序运行在管理环境下,以及使用容器支持的事务管理服务,你就要用ManagedTransactionFactory.

```java
TransactionFactory txnFactory = new ManagedTransactionFactory();
```

### DataSource

```java
String driver = "com.mysql.jdbc.Driver";
String url = "jdbc:mysql://localhost:3306/mybatis_review";
String username = "root";
String password = "admin";
DataSource dataSource =  new PooledDataSource(driver,url,username,password);
```

在实际生产环境中,我们会在应用服务器中配置DataSource,然后通过JNDI获取DataSource.

```java
public class DataSourceFactory
{
    public static DataSource getDataSource()
    {
        String jndiName = "java:comp/env/jdbc/MyBatisDemoDS";
        try {
            InitialContext ctx = new InitialContext();
            DataSource dataSource = (DataSource) ctx.lookup(jndiName);
            return dataSource;
        }
        catch (NamingException e) {
            throw new RuntimeException(e);
        }
    }
}
```

网上有很多第三方库,实现了javax.sql.DataSource接口,我们可以使用这些库来创建DataSource.

## Configuration

```java
Configuration configuration = new Configuration(environment);
```

## typeAliases

MyBatis提供多种方法来实现在Configuration对象上注册TypeAliases.

```java
// 使用首字母小写的类名作为别名
configuration.getTypeAliasRegistry().registerAlias(Student.class);
// 使用Student作为类型别名
configuration.getTypeAliasRegistry().registerAlias("Student",Student.class);
// 
configuration.getTypeAliasRegistry().registerAlias("Student",
                                                   "com.mybatis3.domain.Student");
// 为包中所有类注册别名
configuration.getTypeAliasRegistry().registerAliases("com.mybatis3.domain");
// 为包中所有继承Identifiable的类注册别名
configuration.getTypeAliasRegistry().registerAliases("com.mybatis3.domain", 
                                                     Identifiable.class);
```

## 注册typeHandler

```java
configuration.getTypeHandlerRegistry().register(PhoneNumber.class,PhoneTypeHandler.class);

configuration.getTypeHandlerRegistry().register(PhoneTypeHandler.class);

configuration.getTypeHandlerRegistry().register("com.mybatis3.typehandlers");
```

## Settings

```java
configuration.setCacheEnabled(true);
configuration.setLazyLoadingEnabled(false);
configuration.setMultipleResultSetsEnabled(true);
configuration.setUseColumnLabel(true);
configuration.setUseGeneratedKeys(false);
configuration.setAutoMappingBehavior(AutoMappingBehavior.PARTIAL);
configuration.setDefaultExecutorType(ExecutorType.SIMPLE);
configuration.setDefaultStatementTimeout(25);
configuration.setSafeRowBoundsEnabled(false);
configuration.setMapUnderscoreToCamelCase(false);
configuration.setLocalCacheScope(LocalCacheScope.SESSION);
configuration.setAggressiveLazyLoading(true);
configuration.setJdbcTypeForNull(JdbcType.OTHER);
Set<String> lazyLoadTriggerMethods = new HashSet<String>();
lazyLoadTriggerMethods.add("equals");
lazyLoadTriggerMethods.add("clone");
lazyLoadTriggerMethods.add("hashCode");
lazyLoadTriggerMethods.add("toString");
configuration.setLazyLoadTriggerMethods(lazyLoadTriggerMethods );
```

## Mappers

```java
configuration.addMapper(StudentMapper.class);
configuration.addMappers("com.mybatis3.mappers");
// 注册在com.mybatis3.mappers中,实现了BaseMapper接口的映射文件
configuration.addMappers("com.mybatis3.mappers", BaseMapper.class);
```

## SqlSessionFactory

之前我们是根据xml文件来创建SqlSessionFactory,现在我们使用代码来创建SqlSessionFactory

```java
public static SqlSessionFactory getSqlSessionFactory()
{
    SqlSessionFactory sqlSessionFactory = null;
    try{
        sqlSessionFactory = new SqlSessionFactoryBuilder().build(configuration);
    }catch (Exception e){
    	throw new RuntimeException(e);
    }
    return sqlSessionFactory;
}
```

## 自定义MyBatis日志

MyBatis使用它内部的LoggerFactory作为门面,其内部则是把记录工作委派给下面这些记录实现类.

• SLF4J
• Apache Commons Logging
• Log4j 2
• Log4j
• JDK logging

如果上面的实现类都不存在,则不会进行记录.

如果你程序的运行环境具有上述多个记录实现类,而你又想使用某个实现类,你可以使用下面的方法.

• org.apache.ibatis.logging.LogFactory.useSlf4jLogging();
• org.apache.ibatis.logging.LogFactory.useLog4JLogging();
• org.apache.ibatis.logging.LogFactory.useLog4J2Logging();
• org.apache.ibatis.logging.LogFactory.useJdkLogging();
• org.apache.ibatis.logging.LogFactory.useCommonsLogging();
• org.apache.ibatis.logging.LogFactory.useStdOutLogging();

