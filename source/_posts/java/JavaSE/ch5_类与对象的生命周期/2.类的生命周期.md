---
title : 2.类的生命周期
categories : 
- JavaSE
- ch5类与对象的生命周期
date : 2018-10-30
---

# 类的生命周期

类的生命周期，从类被加载、连接和初始化开始，到类被卸载结束。

## 类的加载

Java程序需要使用某个类时，Java虚拟机会确保这个类已经被加载、连接和初始化。其中连接过程又分为验证、准备和解析这三个子步骤。

![1540873591543](https://github.com/huangdaren1997/pictures/blob/master/%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD%E8%BF%9E%E6%8E%A5%E5%88%9D%E5%A7%8B%E5%8C%96.png?raw=true)

类的加载是指把类的.class文件中的二进制数据读入到java内存的方法区内，然后在java堆里创建一个java.lang.Class对象，用来封装类在方法区内的数据结构，并向java程序提供了访问类在方法区的数据结构和接口。

![1540878379661](https://github.com/huangdaren1997/pictures/blob/master/%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD.png?raw=true)



java虚拟机能够从多种来源加载类的二进制数据

- 从本地文件系统加载类的.class文件
- 通过网络下载类的.class文件
- 从ZIP、JAR或其他归档文件中提取.class文件
- 从一个专有数据库中提取.class文件
- 把一个java源文件动态编译为.class文件

## 类的连接

当类被加载后，就进入连接阶段，连接就是把已经读入到内存的类的二进制数据合并到虚拟机的运行时环境中去。

### 类的验证

保证被加载的类具有正确的内部结构。

### 类的准备

为类的静态变量分配内存，并设置默认初始值；

### 类的解析

把二进制数据中的符号引用替换为直接引用

```java
public void gotoWrok(){
    car.run(); // 这个car.run()就是符号引用，在解析阶段，会被替换成这个方法在内存位置的指针。
}
```

## 类的初始化

在初始化阶段，Java虚拟机执行类的初始化语句，为类的静态变量赋予初始值。

初始化一个类包含一下步骤：

- 加入该类没有被加载，那就先加载和连接
- 如果该类的直接父类还没有初始化，那就先初始化直接父类
- 如果类中存在初始化语句，那就依次执行初始化语句

### 类的初始化时机

前面讲过，Java虚拟机只有在程序首次主动使用一个类或接口时才会初始化它，下面行为属于主动使用

- 创建类的实例，例如new、反射、克隆、反序列化
- 调用类的静态方法
- 访问或操作某个类或接口的静态变量
- 启动Java虚拟机时，指定运行的类 例如 `java Sample`

**注意**

对于final类型的静态变量，如果在编译时就能计算出变量的取值，那么这个变量会被看做是编译时常量，访问它不会导致类的初始化。

## 类的卸载

Java虚拟机自带的类加载器所加载的类，在虚拟机的生命周期中，始终不会被卸载。也就是用户自定义的类加载器所加载的类才会被卸载

# 类加载器

类的加载是由类加载器来完成的，类加载器分为两种：

- Java虚拟机自带的加载器
- 用户自定义的类加载器

注意：类加载器可以在预料某个类将要被使用时就预先加载它，如果在预先加载过程，遇到.class文件缺失或存在错误，类加载器必须等到程序首次主动使用该类时才报告错误。如果该类没有被程序主动使用，则不报错。

类的加载过程采用父亲委托机制，除了Java虚拟机自带的根类加载器以外，其余的类加载器都有且只有一个父加载器。

例如Java程序请求加载器A加载Sample类，加载器A会先委托自己的父类去加载Sample类，如果父类无法加载，那么才由加载器A来加载Sample类。

**Java虚拟机自带以下几种加载器**

- 根类加载器：没有父类加载器，负责加载核心类库，例如java.lang.*等
- 扩展类加载器：根类加载器是它的父加载器，它从java.ext.dirs系统属性所指定的目录下加载类库，或者从JDK的安装目录的jre\lib\ext子目录下加载。它是java.lang.ClassLoader类的子类。
- 系统类加载器：扩展类加载器是它的父加载器，它从classpath环境变量或者系统属性java.class.path所指定的目录中加载类。它是java.lang.ClassLoader类的子类。

![1540882432409](https://github.com/huangdaren1997/pictures/blob/master/%E5%8A%A0%E8%BD%BD%E5%99%A8%E4%B9%8B%E9%97%B4%E7%9A%84%E7%88%B6%E5%AD%90%E5%85%B3%E7%B3%BB.png?raw=true)

**除了Java虚拟机自带的加载器，我们还能自定义自己的类加载器**

